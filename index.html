<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ESP32 BLE -> Web Bluetooth Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:40px auto; }
    button{ margin:6px; padding:10px 14px; }
    #log { white-space: pre-wrap; background:#f5f5f5; border:1px solid #ddd; padding:10px; height:240px; overflow:auto; }
    .controls { margin-top:12px; }
  </style>
</head>
<body>
  <h2>ESP32 BLE Web Demo</h2>
  <p>Device name: <b>ESP32-simple</b> — Service UUID: <code>0000ffee-0000-1000-8000-00805f9b34fb</code></p>

  <div>
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
  </div>

  <div class="controls">
    <button id="btnPing" disabled>PING</button>
    <button id="btnLedOn" disabled>LED ON</button>
    <button id="btnLedOff" disabled>LED OFF</button>
    <input id="echoInput" placeholder="ECHO text" />
    <button id="btnEcho" disabled>Send ECHO</button>
  </div>

  <h3>Notifications / Log</h3>
  <div id="log">No connection yet.</div>

<script>
const SERVICE_UUID = '0000ffee-0000-1000-8000-00805f9b34fb';
const CHAR_CMD_UUID = '0000ffef-0000-1000-8000-00805f9b34fb';    // write
const CHAR_NOTIFY_UUID = '0000fff0-0000-1000-8000-00805f9b34fb'; // notify

let device = null;
let server = null;
let cmdChar = null;
let notifyChar = null;

const logEl = document.getElementById('log');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const btnPing = document.getElementById('btnPing');
const btnLedOn = document.getElementById('btnLedOn');
const btnLedOff = document.getElementById('btnLedOff');
const btnEcho = document.getElementById('btnEcho');
const echoInput = document.getElementById('echoInput');

function log(...args) {
  const t = new Date().toLocaleTimeString();
  logEl.textContent = t + '  ' + args.join(' ') + '\n' + logEl.textContent;
}

// convert string -> bytes
function strToBytes(s) {
  return new TextEncoder().encode(s);
}
function bytesToStr(buf) {
  return new TextDecoder().decode(buf);
}

async function connect() {
  try {
    log('Requesting Bluetooth device...');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'ESP32' }], // helps but optional
      optionalServices: [SERVICE_UUID]
    });

    device.addEventListener('gattserverdisconnected', onDisconnected);

    log('Connecting GATT server...');
    server = await device.gatt.connect();

    log('Getting service...');
    const service = await server.getPrimaryService(SERVICE_UUID);

    log('Getting characteristics...');
    // get both characteristics
    cmdChar = await service.getCharacteristic(CHAR_CMD_UUID);
    notifyChar = await service.getCharacteristic(CHAR_NOTIFY_UUID);

    // enable notifications
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', handleNotifications);

    log('Connected — characteristics ready.');
    setConnected(true);
  } catch (err) {
    log('ERROR', err);
    setConnected(false);
  }
}

function onDisconnected() {
  log('Device disconnected.');
  setConnected(false);
}

function setConnected(connected) {
  btnConnect.disabled = connected;
  btnDisconnect.disabled = !connected;
  btnPing.disabled = !connected;
  btnLedOn.disabled = !connected;
  btnLedOff.disabled = !connected;
  btnEcho.disabled = !connected;
}

async function disconnect() {
  if (!device) return;
  if (device.gatt.connected) {
    device.gatt.disconnect();
  }
  setConnected(false);
  log('Disconnected by user.');
}

function handleNotifications(event) {
  const value = event.target.value;
  // value is a DataView
  const bytes = new Uint8Array(value.buffer);
  const s = bytesToStr(bytes);
  log('Notification:', s);
}

async function writeCommand(text) {
  if (!cmdChar) {
    log('Command characteristic not found.');
    return;
  }
  try {
    const data = strToBytes(text);
    await cmdChar.writeValue(data);
    log('Wrote:', text);
  } catch (err) {
    log('Write ERROR:', err);
  }
}

// Button handlers
btnConnect.addEventListener('click', connect);
btnDisconnect.addEventListener('click', disconnect);
btnPing.addEventListener('click', ()=> writeCommand('PING'));
btnLedOn.addEventListener('click', ()=> writeCommand('LED_ON'));
btnLedOff.addEventListener('click', ()=> writeCommand('LED_OFF'));
btnEcho.addEventListener('click', ()=> {
  const txt = echoInput.value || 'Hello';
  writeCommand('ECHO ' + txt);
});
</script>
</body>
</html>
