<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 via MQTT (Web)</title>
  <style>
    body{font-family:Arial; max-width:900px;margin:20px auto}
    button{margin:6px;padding:8px 12px}
    #log{background:#f7f7f7;border:1px solid #ddd;padding:8px;height:300px;overflow:auto;white-space:pre-wrap}
    input{padding:6px}
  </style>
</head>
<body>
  <h2>ESP32 -> Web via MQTT</h2>
  <p>Broker: <b>broker.hivemq.com</b> (public)</p>

  <div>
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
  </div>

  <div style="margin-top:12px">
    <button id="btnPing" disabled>Send: PING</button>
    <button id="btnLedOn" disabled>Send: LED_ON</button>
    <button id="btnLedOff" disabled>Send: LED_OFF</button>
    <input id="txtEcho" placeholder="ECHO text" />
    <button id="btnEcho" disabled>Send ECHO</button>
  </div>

  <h3>Log</h3>
  <div id="log">No connection</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const broker = 'broker.hivemq.com';
const wsUrl = `wss://${broker}:8884/mqtt`; // HiveMQ secure websockets (might work). If fails, try ws://broker.hivemq.com:8000/mqtt
let client = null;
const logEl = document.getElementById('log');
function log(...args){
  const t = new Date().toLocaleTimeString();
  logEl.textContent = t + ' ' + args.join(' ') + '\n' + logEl.textContent;
}

function setConnected(c){
  document.getElementById('btnConnect').disabled = c;
  document.getElementById('btnDisconnect').disabled = !c;
  ['btnPing','btnLedOn','btnLedOff','btnEcho'].forEach(id => document.getElementById(id).disabled = !c);
}

document.getElementById('btnConnect').addEventListener('click', ()=>{
  log('Connecting to broker', wsUrl);
  client = mqtt.connect(wsUrl, { keepalive: 30, reconnectPeriod: 5000 });
  client.on('connect', () => {
    log('MQTT connected');
    setConnected(true);
    client.subscribe('esp32/hello');
    client.subscribe('esp32/ack');
  });
  client.on('message', (topic, message) => {
    log('MSG', topic, ':', message.toString());
  });
  client.on('error', (err) => log('MQTT error', err));
  client.on('close', () => { log('MQTT closed'); setConnected(false); });
});

document.getElementById('btnDisconnect').addEventListener('click', ()=> {
  if (client) client.end();
});

function sendCmd(txt){
  if (!client || !client.connected) { log('Not connected'); return; }
  client.publish('esp32/cmd', txt);
  log('Sent cmd:', txt);
}

document.getElementById('btnPing').addEventListener('click', ()=> sendCmd('PING'));
document.getElementById('btnLedOn').addEventListener('click', ()=> sendCmd('LED_ON'));
document.getElementById('btnLedOff').addEventListener('click', ()=> sendCmd('LED_OFF'));
document.getElementById('btnEcho').addEventListener('click', ()=> {
  const t = document.getElementById('txtEcho').value || 'hello';
  sendCmd('ECHO ' + t);
});
</script>
</body>
</html>
